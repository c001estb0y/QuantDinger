# 股指期货结算价差套利策略 - 详细需求文档

> **文档版本**: v2.1 (MVP简化版)  
> **创建时间**: 2026-02-04  
> **更新时间**: 2026-02-04  
> **策略位置**: `/strategies/index_futures_settlement_arbitrage.py`  
> **状态**: ✅ 需求已确认，待开发

---

## 📋 目录

1. [策略概述](#1-策略概述)
2. [MVP简化说明](#2-mvp简化说明)
3. [当前项目能力分析](#3-当前项目能力分析)
4. [已确认的技术方案](#4-已确认的技术方案)
5. [开发任务清单](#5-开发任务清单)
6. [优先级排序](#6-优先级排序)
7. [实施计划](#7-实施计划)

---

## 1. 策略概述

### 1.1 策略原理

利用**股指期货收盘价与结算价的差异**进行套利：
- 股指期货结算价 = 最后一小时VWAP（成交量加权平均价）
- 尾盘非理性下跌时，收盘价往往低于结算价
- 买入持有到次日开盘可获取价差收益

### 1.2 交易规则（MVP版）

| 规则 | 描述 |
|------|------|
| **品种** | IC（中证500）、IM（中证1000）**主力合约** |
| **入场条件1** | 14:30后，价格相对14:30下跌超过1% |
| **入场条件2** | 累计下跌超过2%时追加买入 |
| **出场条件** | 次日开盘卖出 |

### 1.3 预期收益

| 案例 | 价差 | 预计收益 |
|------|------|----------|
| 股指期货 | 100点 | ≈2万/手 |
| 黄金期货 | 8% | ≈8万/手 |

---

## 2. MVP简化说明

### 2.1 🎯 MVP核心原则

**快速验证策略可行性，不追求完美**

### 2.2 简化内容对比

| 功能 | 原始方案 | MVP简化方案 | 理由 |
|------|----------|-------------|------|
| **合约选择** | 远月合约 | ✅ **主力合约** | 数据易获取，流动性好 |
| **移仓换月** | 完整逻辑 | ❌ **暂不支持** | 主力合约自动切换 |
| **多合约管理** | 同时持有多月份 | ❌ **单合约** | 简化逻辑 |
| **数据深度** | 1年历史 | ✅ **3个月先测试** | 快速验证 |

### 2.3 主力合约优势

| 优势 | 说明 |
|------|------|
| ✅ **数据获取简单** | 各平台都有主力连续数据 |
| ✅ **流动性最好** | 买卖价差小，滑点低 |
| ✅ **代码简单** | 不用处理合约切换逻辑 |
| ✅ **快速验证** | 几天内就能看到回测结果 |

### 2.4 主力合约代码

| 品种 | 主力合约代码 | 说明 |
|------|-------------|------|
| 中证500 | `IC0` 或 `IC_M` | 主力连续 |
| 中证1000 | `IM0` 或 `IM_M` | 主力连续 |
| 沪深300 | `IF0` 或 `IF_M` | 主力连续 |
| 上证50 | `IH0` 或 `IH_M` | 主力连续 |

---

## 3. 当前项目能力分析

### 3.1 ✅ 已支持的功能

| 功能模块 | 状态 | 说明 |
|----------|------|------|
| 策略开发框架 | ✅ 完善 | Python策略开发，支持buy/sell信号 |
| 数据源架构 | ✅ 完善 | 工厂模式，支持多市场扩展 |
| A股数据 | ✅ 支持 | 东方财富/腾讯/yfinance/akshare多源 |
| 港股数据 | ✅ 支持 | 同上 |
| 加密货币数据 | ✅ 支持 | CCXT，100+交易所 |
| 美股数据 | ✅ 支持 | yfinance/finnhub |
| 外汇数据 | ✅ 支持 | Tiingo |
| 国际期货数据 | ✅ 支持 | Yahoo Finance (GC/SI/CL/NG等) |
| 加密货币期货 | ✅ 支持 | Binance Futures via CCXT |
| IBKR实盘交易 | ✅ 支持 | 美股/港股 |
| MT5实盘交易 | ✅ 支持 | 外汇 |
| 通知系统 | ✅ 支持 | Email/SMS/Telegram |
| 分钟级K线 | ✅ 支持 | 1m/5m/15m/30m/1H/4H |

### 3.2 ⏳ 待开发的功能（MVP精简版）

| 功能模块 | 现状 | 需要开发 |
|----------|------|----------|
| **中国期货数据** | ❌ 不支持 | 需要新增IC/IM主力合约数据源 |
| **回测引擎（期货）** | ⚠️ 有限支持 | 需要支持期货保证金、手续费计算 |
| **策略通知增强** | ⚠️ 有限支持 | 需要增加价格预警、盈亏通知 |

---

## 4. 已确认的技术方案

### 4.1 用户选择汇总（MVP更新）

| 问题 | 选择 | 说明 |
|------|------|------|
| **数据源** | ✅ B - akshare | 免费开源，集成简单 |
| **合约类型** | ✅ **主力合约** | MVP简化，数据易获取 |
| **历史数据深度** | ✅ 3个月（MVP）/ 1年（完整） | 先快速验证 |
| **交易接口** | ✅ C - 暂不开发 | 先回测验证策略效果 |
| **账户类型** | ✅ A - SimNow仿真 | 未来对接时使用仿真环境 |
| **时间控制** | ✅ A - 策略内部判断 | 已在策略代码中实现 |
| **回测功能** | ✅ 保证金/手续费/结算价/涨跌停 | ~~移仓换月~~ MVP不需要 |
| **通知功能** | ✅ 全部需要 | 买卖信号/价格预警/盈亏通知 |

---

### 4.2 数据源方案 - akshare（MVP简化）

#### 4.2.1 技术选型

```python
# 使用 akshare 获取中国股指期货【主力合约】数据
import akshare as ak

# 获取主力合约分钟K线数据
# 方法1: 新浪数据源 - 主力连续
kline_data = ak.futures_zh_minute_sina(symbol="IC0", period="1")

# 方法2: 指定具体主力合约（如 IC2503）
kline_data = ak.futures_zh_minute_sina(symbol="IC2503", period="1")

# 获取主力合约代码
main_contract = ak.futures_main_sina(symbol="IC")  # 返回当前主力合约代码
```

#### 4.2.2 数据范围（MVP）

| 数据类型 | 来源 | 频率 | 历史深度 |
|----------|------|------|----------|
| 分钟K线 | 新浪/东财 | 1m/5m/15m/30m/60m | **3个月（MVP）** |
| 日线数据 | akshare | 日 | 3年+ |
| 实时行情 | 新浪 | 延迟约3秒 | 实时 |

#### 4.2.3 支持的主力合约代码

| 品种 | 代码 | 说明 |
|------|------|------|
| 中证500 | `IC0` | 主力连续 |
| 中证1000 | `IM0` | 主力连续 |
| 沪深300 | `IF0` | 主力连续 |
| 上证50 | `IH0` | 主力连续 |

---

### 4.3 交易接口方案 - 暂不开发

**当前阶段**：仅回测验证策略效果

**未来规划**：
- 当策略回测验证有效后，再考虑接入CTP交易接口
- 优先使用SimNow仿真环境进行测试
- 可选方案：vnpy CTP / ctpwrapper

---

### 4.4 回测引擎增强方案（MVP简化）

#### 4.4.1 保证金计算

```python
# 股指期货保证金计算
class FuturesMarginCalculator:
    MARGIN_RATIOS = {
        'IC': 0.12,  # 中证500，12%
        'IM': 0.12,  # 中证1000，12%
        'IF': 0.10,  # 沪深300，10%
        'IH': 0.10,  # 上证50，10%
    }
    
    def calculate(self, symbol, price, multiplier=200):
        """
        计算保证金
        IC/IM: 每点200元
        IF/IH: 每点300元
        """
        contract_value = price * multiplier
        margin_ratio = self.MARGIN_RATIOS.get(symbol[:2], 0.12)
        return contract_value * margin_ratio
```

#### 4.4.2 手续费计算

```python
class FuturesFeeCalculator:
    # 手续费率（按成交金额）
    FEE_RATES = {
        'IC': {'open': 0.000023, 'close': 0.000023, 'close_today': 0.000345},
        'IM': {'open': 0.000023, 'close': 0.000023, 'close_today': 0.000345},
        'IF': {'open': 0.000023, 'close': 0.000023, 'close_today': 0.000345},
        'IH': {'open': 0.000023, 'close': 0.000023, 'close_today': 0.000345},
    }
    
    def calculate(self, symbol, price, multiplier, is_close_today=False):
        """计算手续费"""
        contract_value = price * multiplier
        fee_type = 'close_today' if is_close_today else 'open'
        rate = self.FEE_RATES[symbol[:2]][fee_type]
        return contract_value * rate
```

#### 4.4.3 结算价模拟（VWAP）

```python
def calculate_settlement_price(minute_bars):
    """
    计算结算价 = 最后一小时VWAP
    股指期货结算价采用最后一小时成交量加权平均价
    """
    # 筛选14:00-15:00的数据
    last_hour = minute_bars[minute_bars['time'] >= '14:00:00']
    
    if len(last_hour) == 0:
        return minute_bars['close'].iloc[-1]
    
    # VWAP = Σ(价格 × 成交量) / Σ成交量
    vwap = (last_hour['close'] * last_hour['volume']).sum() / last_hour['volume'].sum()
    return vwap
```

#### 4.4.4 涨跌停处理

```python
def check_price_limit(symbol, price, prev_settlement):
    """
    检查涨跌停
    股指期货涨跌停板：±10%（基于前结算价）
    """
    limit_ratio = 0.10
    upper_limit = prev_settlement * (1 + limit_ratio)
    lower_limit = prev_settlement * (1 - limit_ratio)
    
    if price >= upper_limit:
        return 'LIMIT_UP', upper_limit
    elif price <= lower_limit:
        return 'LIMIT_DOWN', lower_limit
    return 'NORMAL', price
```

#### 4.4.5 ~~移仓换月逻辑~~ （MVP不需要）

> ⚠️ **MVP版本使用主力合约，暂不需要移仓换月逻辑**
> 
> 主力合约会自动切换到最活跃的合约月份，数据源已处理好连续性。
> 
> 完整版本开发时再添加此功能。

---

### 4.5 通知功能方案

#### 4.5.1 通知类型

| 通知类型 | 触发条件 | 优先级 |
|----------|----------|--------|
| **买入信号** | 14:30后下跌>1%触发买入 | 🔴 高 |
| **卖出信号** | 次日开盘卖出 | 🔴 高 |
| **价格预警** | 接近1%阈值（如0.8%时） | 🟡 中 |
| **盈亏通知** | 交易完成后发送盈亏报告 | 🟢 低 |

#### 4.5.2 通知模板

```python
# 买入信号通知
BUY_SIGNAL_TEMPLATE = """
🚀 【买入信号】股指期货结算价套利

📊 合约: {symbol} (主力)
📉 当前价: {current_price}
📌 14:30价: {base_price}
📉 跌幅: {drop_pct:.2f}%
⏰ 时间: {time}

💡 建议: 买入1手，持有至次日开盘
"""

# 卖出信号通知
SELL_SIGNAL_TEMPLATE = """
📤 【卖出信号】股指期货结算价套利

📊 合约: {symbol} (主力)
💰 开盘价: {open_price}
📈 昨收: {prev_close}
📊 预计收益: {profit:.2f}元
⏰ 时间: {time}

💡 建议: 开盘卖出平仓
"""

# 价格预警通知
PRICE_ALERT_TEMPLATE = """
⚠️ 【价格预警】接近买入阈值

📊 合约: {symbol} (主力)
📉 当前跌幅: {drop_pct:.2f}%
🎯 触发阈值: 1.00%
⏰ 时间: {time}

💡 请关注: 即将触发买入信号
"""

# 盈亏报告通知
PNL_REPORT_TEMPLATE = """
📊 【交易报告】股指期货结算价套利

📋 合约: {symbol} (主力)
💰 买入价: {entry_price}
💰 卖出价: {exit_price}
📈 收益: {profit:.2f}元 ({profit_pct:.2f}%)
⏰ 持仓时间: {hold_time}

📊 本月累计: {monthly_pnl:.2f}元
"""
```

---

## 5. 开发任务清单（MVP精简版）

### 5.1 数据源模块（MVP）

| 任务ID | 任务描述 | 预计工时 | 依赖 | MVP必需 |
|--------|----------|----------|------|---------|
| D-01 | 创建 `CNFuturesDataSource` 类 | 2h | - | ✅ |
| D-02 | 实现akshare主力合约K线获取 | 1h | D-01 | ✅ |
| D-03 | 实现主力合约代码识别 | 0.5h | D-01 | ✅ |
| D-04 | 实现3个月历史数据下载 | 1h | D-02 | ✅ |
| D-05 | 集成到 `DataSourceFactory` | 0.5h | D-01 | ✅ |
| D-06 | 编写数据源单元测试 | 1h | D-01~D-05 | ⚪ |

**MVP数据源工时: ~5小时**

### 5.2 回测引擎模块（MVP）

| 任务ID | 任务描述 | 预计工时 | 依赖 | MVP必需 |
|--------|----------|----------|------|---------|
| B-01 | 实现期货保证金计算器 | 1h | - | ✅ |
| B-02 | 实现期货手续费计算器 | 1h | - | ✅ |
| B-03 | 实现结算价(VWAP)计算 | 2h | D-02 | ✅ |
| B-04 | 实现涨跌停处理逻辑 | 1h | - | ✅ |
| ~~B-05~~ | ~~实现移仓换月逻辑~~ | ~~3h~~ | - | ❌ 移除 |
| B-06 | 集成到回测引擎主流程 | 2h | B-01~B-04 | ✅ |
| B-07 | 编写回测引擎单元测试 | 1h | B-06 | ⚪ |

**MVP回测工时: ~8小时**（比原来减少3小时）

### 5.3 通知模块

| 任务ID | 任务描述 | 预计工时 | 依赖 | MVP必需 |
|--------|----------|----------|------|---------|
| N-01 | 设计通知模板系统 | 0.5h | - | ✅ |
| N-02 | 实现买入/卖出信号通知 | 1h | N-01 | ✅ |
| N-03 | 实现价格预警通知 | 1h | N-01 | ⚪ |
| N-04 | 实现盈亏报告通知 | 1h | N-01 | ⚪ |
| N-05 | 集成到策略执行流程 | 1h | N-02~N-04 | ✅ |

**MVP通知工时: ~4.5小时**

### 5.4 策略优化（MVP后期）

| 任务ID | 任务描述 | 预计工时 | 依赖 | MVP必需 |
|--------|----------|----------|------|---------|
| S-01 | 参数可配置化（阈值、品种等） | 1h | - | ⚪ |
| S-02 | 增加多品种支持(IC/IM/IF/IH) | 1h | D-01 | ⚪ |
| S-03 | 增加风控逻辑（最大持仓等） | 1h | - | ⚪ |

---

## 6. 优先级排序

### 6.1 开发阶段划分（MVP简化）

```
┌─────────────────────────────────────────────────────────────────┐
│                   MVP 开发路线图 (简化版)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  阶段1: 数据获取 (P0)          阶段2: 回测验证 (P1)              │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │ D-01: 数据源类      │      │ B-01~B-04: 回测增强 │           │
│  │ D-02: 主力合约K线   │ ───► │ B-06: 集成测试      │           │
│  │ D-03~D-05: 集成     │      │ (无需移仓换月)      │           │
│  └─────────────────────┘      └─────────────────────┘           │
│         ~5h                          ~8h                         │
│           │                            │                         │
│           ▼                            ▼                         │
│  阶段3: 通知功能 (P2)          阶段4: 策略优化 (P3)              │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │ N-01~N-02: 买卖信号 │      │ S-01~S-03: 参数化   │           │
│  │ (MVP核心功能)       │      │ (可选增强)          │           │
│  └─────────────────────┘      └─────────────────────┘           │
│         ~2.5h                        ~3h                         │
│                                                                  │
│  🎯 MVP总工时: 约 15-17 小时 (原计划 25+ 小时)                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 优先级说明

| 优先级 | 模块 | 原因 |
|--------|------|------|
| **P0** | 数据源 | 基础数据是一切的前提，无数据无法回测 |
| **P1** | 回测引擎 | 验证策略效果，确定是否值得继续开发 |
| **P2** | 通知功能 | 提升实用性，辅助手动交易 |
| **P3** | 策略优化 | 锦上添花，可持续迭代 |

---

## 7. 实施计划

### 7.1 详细时间表（MVP）

| 阶段 | 任务 | 预计时间 | 里程碑 |
|------|------|----------|--------|
| **阶段1** | 数据源开发 | **2-3天** | ✅ 能获取IC/IM主力合约分钟K线 |
| **阶段2** | 回测引擎 | **3-4天** | ✅ 能运行3个月回测 |
| **阶段3** | 通知功能 | **1-2天** | ✅ 能发送买卖信号 |
| **阶段4** | 策略优化 | 可选 | ✅ 支持参数配置 |

**🎯 MVP预计总工期: 1-2周**

### 7.2 交付物清单

| 交付物 | 文件位置 | 说明 |
|--------|----------|------|
| 数据源类 | `/backend_api_python/app/data_sources/cn_futures.py` | 中国期货数据源 |
| 回测增强 | `/backend_api_python/app/backtest/futures_calculator.py` | 期货计算器 |
| 通知模板 | `/backend_api_python/app/notifications/futures_templates.py` | 通知模板 |
| 策略文件 | `/strategies/index_futures_settlement_arbitrage.py` | 策略代码（已有） |
| 配置文件 | `/config/futures_strategy_config.yaml` | 策略参数配置 |

### 7.3 测试计划（MVP）

| 测试类型 | 覆盖范围 | 验收标准 |
|----------|----------|----------|
| 冒烟测试 | 数据获取 | 能成功获取IC0主力合约3个月分钟K线 |
| 回测验证 | 策略效果 | 3个月回测完成，输出胜率和盈亏比 |
| 信号验证 | 通知功能 | 能正确发送买卖信号通知 |

---

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-04 | 初始版本，待确认事项 |
| v2.0 | 2026-02-04 | 用户确认完成，更新技术方案 |
| **v2.1** | **2026-02-04** | **🎯 MVP简化版：使用主力合约，移除移仓换月** |

---

## 🚀 下一步行动

**MVP需求已确认！** 简化后的开发计划：

### ✅ MVP简化要点
- ✅ 只使用**主力合约**（IC0/IM0）
- ✅ **移除**移仓换月逻辑
- ✅ 先用**3个月数据**快速验证
- ✅ 工时从25+小时缩减到**15-17小时**

### 🎯 立即开始开发
1. **第一步** → 创建 `CNFuturesDataSource` 类
2. **第二步** → 实现akshare主力合约数据获取
3. **第三步** → 运行3个月回测验证策略

**是否现在开始开发数据源模块？**
