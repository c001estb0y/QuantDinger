# 股指期货结算价差套利策略 - 完整版需求文档

> **文档版本**: v1.0  
> **创建时间**: 2026-02-09  
> **文档类型**: 完整版功能需求  
> **前置文档**: [CHINA_FUTURES_STRATEGY_REQUIREMENT.md](./CHINA_FUTURES_STRATEGY_REQUIREMENT.md) (MVP版)  
> **状态**: 📝 需求规划中

---

## 📋 目录

1. [概述](#1-概述)
2. [简化版 vs 完整版对比](#2-简化版-vs-完整版对比)
3. [完整版功能清单](#3-完整版功能清单)
4. [核心模块设计](#4-核心模块设计)
5. [数据需求](#5-数据需求)
6. [策略执行引擎](#6-策略执行引擎)
7. [回测系统增强](#7-回测系统增强)
8. [通知与监控](#8-通知与监控)
9. [前端界面设计](#9-前端界面设计)
10. [开发任务清单](#10-开发任务清单)
11. [测试计划](#11-测试计划)
12. [风险与依赖](#12-风险与依赖)

---

## 1. 概述

### 1.1 文档目的

本文档定义**完整版结算价差套利策略**的功能需求，作为从MVP简化版升级到生产级策略系统的开发指南。

### 1.2 策略原理回顾

**核心逻辑**：利用股指期货收盘价与结算价的差异进行套利

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        策略原理图                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   14:00        14:30        15:00                                        │
│     │            │            │                                          │
│     ▼            ▼            ▼                                          │
│   ┌────────────────────────────┐                                        │
│   │     最后一小时交易时段      │                                        │
│   │   结算价 = VWAP(14:00-15:00) │                                       │
│   └────────────────────────────┘                                        │
│                                                                          │
│   场景: 尾盘非理性下跌                                                    │
│   ┌─────────────────────────────────────────────────────────┐           │
│   │  价格                                                    │           │
│   │   │                                                      │           │
│   │   │     ╭────╮                                          │           │
│   │   │    ╱      ╲        结算价 ────────────              │           │
│   │   │   ╱        ╲      ╱                                 │           │
│   │   │──╱          ╲────╱                                  │           │
│   │   │                    ╲                                │           │
│   │   │                     ╲──── 收盘价                    │           │
│   │   │                                                      │           │
│   │   └──────────────────────────────────────────────→ 时间  │           │
│   │        14:00   14:30   15:00                             │           │
│   │                                                          │           │
│   │  ★ 收盘价 < 结算价 → 买入持有 → 次日获利                  │           │
│   └─────────────────────────────────────────────────────────┘           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 为什么需要完整版？

| 简化版局限 | 完整版解决方案 |
|------------|----------------|
| 只能用日K线，无法精确判断14:30价格 | 支持分钟级K线，精确时间判断 |
| 无法计算真实结算价(VWAP) | 实时计算最后一小时VWAP |
| 无法分批建仓（1%、2%追加） | 支持多档位条件触发 |
| 无法指定"次日开盘价"成交 | 支持订单类型和成交价指定 |
| 没有资金管理和风控 | 完整的仓位管理和风控系统 |
| 没有实时监控和预警 | 实时监控+多通道预警 |

---

## 2. 简化版 vs 完整版对比

### 2.1 功能对比表

| 功能维度 | 简化版 (指标编辑器) | 完整版 (独立策略模块) |
|----------|---------------------|----------------------|
| **数据频率** | 日K线 | 1分钟/5分钟K线 |
| **时间判断** | ❌ 不支持 | ✅ 精确到分钟 |
| **结算价计算** | ❌ 不支持 | ✅ 实时VWAP计算 |
| **入场条件** | 日跌幅>1% | 14:30后价格下跌>1% |
| **分批建仓** | ❌ 不支持 | ✅ 1%首仓, 2%追加 |
| **出场条件** | 次日收盘卖 | 次日开盘价卖出 |
| **仓位管理** | ❌ 不支持 | ✅ 最大仓位限制 |
| **风控系统** | ❌ 不支持 | ✅ 止损/止盈/强平 |
| **多品种** | 单品种 | IC/IM/IF/IH 多品种 |
| **移仓换月** | ❌ 不支持 | ✅ 自动移仓 |
| **通知预警** | ❌ 不支持 | ✅ 实时推送 |
| **历史回测** | 基础回测 | 完整期货回测 |
| **绩效分析** | 基础指标 | 详细期货绩效 |

### 2.2 代码架构对比

```
简化版（指标编辑器）:
┌─────────────────────────────────────┐
│  def process(df):                   │
│      # 几十行代码                    │
│      # 输出 buy/sell 信号           │
└─────────────────────────────────────┘

完整版（独立策略模块）:
┌─────────────────────────────────────────────────────────────────┐
│  strategies/                                                     │
│  ├── settlement_arbitrage/                                       │
│  │   ├── __init__.py                                            │
│  │   ├── strategy.py          # 策略主逻辑                       │
│  │   ├── data_handler.py      # 分钟数据处理                     │
│  │   ├── vwap_calculator.py   # 结算价计算                       │
│  │   ├── position_manager.py  # 仓位管理                         │
│  │   ├── risk_manager.py      # 风控系统                         │
│  │   ├── notifier.py          # 通知系统                         │
│  │   └── config.yaml          # 策略配置                         │
│  │                                                               │
│  backend_api_python/app/                                         │
│  ├── data_sources/                                               │
│  │   └── cn_futures.py        # 中国期货数据源                   │
│  ├── backtest/                                                   │
│  │   └── futures_calculator.py # 期货回测增强                    │
│  └── api/                                                        │
│      └── settlement_strategy_api.py  # 策略API                   │
│                                                                  │
│  frontend/src/pages/                                             │
│  └── SettlementStrategy/      # 策略专属界面                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 完整版功能清单

### 3.1 核心功能 (P0 - 必须实现)

| ID | 功能 | 描述 | 验收标准 |
|----|------|------|----------|
| **F-01** | 分钟级数据获取 | 获取IC/IM/IF/IH主力合约1分钟K线 | 能获取当日实时数据 |
| **F-02** | 结算价计算(VWAP) | 实时计算最后一小时成交量加权平均价 | 计算误差<0.1% |
| **F-03** | 精确时间判断 | 判断14:30后的价格变动 | 时间精确到秒 |
| **F-04** | 入场信号生成 | 14:30后跌幅>1%触发买入信号 | 信号准确无漏 |
| **F-05** | 出场信号生成 | 次日开盘生成卖出信号 | 自动识别新交易日 |
| **F-06** | 买卖信号通知 | 通过Telegram/Email发送信号 | 延迟<30秒 |

### 3.2 增强功能 (P1 - 重要)

| ID | 功能 | 描述 | 验收标准 |
|----|------|------|----------|
| **F-07** | 分批建仓 | 1%首仓，2%追加 | 最多2档建仓 |
| **F-08** | 仓位管理 | 单品种最大持仓限制 | 可配置手数上限 |
| **F-09** | 多品种支持 | 同时监控IC/IM/IF/IH | 4品种并行 |
| **F-10** | 价格预警 | 接近阈值时预警(0.8%) | 提前预警 |
| **F-11** | 策略参数配置 | 可视化配置阈值/品种等 | 无需改代码 |
| **F-12** | 历史数据回测 | 1年以上历史数据回测 | 完整绩效报告 |

### 3.3 高级功能 (P2 - 锦上添花)

| ID | 功能 | 描述 | 验收标准 |
|----|------|------|----------|
| **F-13** | 移仓换月 | 主力合约自动切换 | 平滑过渡 |
| **F-14** | 风控止损 | 单日最大亏损限制 | 触发强平 |
| **F-15** | 绩效统计 | 日/周/月盈亏报表 | 自动生成 |
| **F-16** | 策略监控面板 | 实时展示策略状态 | 可视化界面 |
| **F-17** | 交易日历 | 节假日/非交易日处理 | 自动跳过 |
| **F-18** | CTP交易对接 | SimNow仿真/实盘交易 | (未来规划) |

---

## 4. 核心模块设计

### 4.1 模块架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          完整版策略架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐      │
│  │   数据层         │    │   策略层         │    │   执行层         │      │
│  │                 │    │                 │    │                 │      │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │      │
│  │ │MinuteData   │ │───►│ │StrategyCore│ │───►│ │ SignalQueue │ │      │
│  │ │Handler      │ │    │ │             │ │    │ │             │ │      │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │      │
│  │        │        │    │        │        │    │        │        │      │
│  │        ▼        │    │        ▼        │    │        ▼        │      │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │      │
│  │ │VWAPCalc     │ │    │ │PositionMgr │ │    │ │ Notifier    │ │      │
│  │ │             │ │    │ │             │ │    │ │             │ │      │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │      │
│  │        │        │    │        │        │    │        │        │      │
│  │        ▼        │    │        ▼        │    │        ▼        │      │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │      │
│  │ │DataCache    │ │    │ │ RiskManager │ │    │ │ (CTP/模拟)  │ │      │
│  │ │             │ │    │ │             │ │    │ │             │ │      │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │      │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 模块职责

| 模块 | 职责 | 主要接口 |
|------|------|----------|
| **MinuteDataHandler** | 分钟K线数据获取与管理 | `get_minute_bars()`, `subscribe()` |
| **VWAPCalculator** | 结算价(VWAP)实时计算 | `calculate_vwap()`, `get_settlement_price()` |
| **DataCache** | 数据缓存与历史存储 | `cache_bars()`, `get_history()` |
| **StrategyCore** | 策略核心逻辑 | `check_entry()`, `check_exit()` |
| **PositionManager** | 仓位管理 | `open_position()`, `close_position()` |
| **RiskManager** | 风控管理 | `check_risk()`, `force_close()` |
| **SignalQueue** | 信号队列 | `push_signal()`, `pop_signal()` |
| **Notifier** | 通知发送 | `send_buy_alert()`, `send_sell_alert()` |

---

## 5. 数据需求

### 5.1 数据源要求

| 数据类型 | 来源 | 频率 | 延迟要求 | 历史深度 |
|----------|------|------|----------|----------|
| 分钟K线 | akshare (新浪) | 1分钟 | <5秒 | 1年 |
| 日K线 | akshare | 日 | <1分钟 | 3年 |
| 实时Tick | 新浪 | 3秒 | <5秒 | 当日 |
| 交易日历 | akshare | 静态 | - | 10年 |
| 主力合约映射 | akshare | 日 | - | 当前 |

### 5.2 数据字段要求

#### 分钟K线字段

```python
{
    "datetime": "2026-02-08 14:31:00",  # 时间戳
    "symbol": "IM2503",                  # 合约代码
    "open": 5850.0,                      # 开盘价
    "high": 5855.2,                      # 最高价
    "low": 5848.6,                       # 最低价
    "close": 5852.4,                     # 收盘价
    "volume": 1234,                      # 成交量(手)
    "amount": 144276000.0,               # 成交额(元)
    "position": 45678                    # 持仓量
}
```

#### 数据接口定义

```python
class CNFuturesDataSource:
    """中国期货数据源"""
    
    def get_minute_bars(
        self, 
        symbol: str,           # 合约代码，如 "IM0" 或 "IM2503"
        period: int = 1,       # K线周期(分钟): 1/5/15/30/60
        count: int = 240       # 获取数量
    ) -> pd.DataFrame:
        """获取分钟K线数据"""
        pass
    
    def get_main_contract(self, product: str) -> str:
        """获取主力合约代码，如 "IM" -> "IM2503" """
        pass
    
    def get_trading_calendar(self, year: int) -> List[date]:
        """获取交易日历"""
        pass
    
    def is_trading_time(self) -> bool:
        """判断当前是否为交易时间"""
        pass
```

### 5.3 数据存储方案

```
data/
├── futures/
│   ├── minute/                    # 分钟K线存储
│   │   ├── IM/
│   │   │   ├── 2026-02-08.parquet
│   │   │   └── ...
│   │   └── IC/
│   │       └── ...
│   ├── daily/                     # 日K线存储
│   │   └── main_contracts.parquet
│   └── cache/                     # 实时数据缓存
│       └── realtime.db (SQLite)
```

---

## 6. 策略执行引擎

### 6.1 策略状态机

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          策略状态流转图                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                        ┌─────────────┐                                  │
│                        │   IDLE      │                                  │
│                        │   (空仓)     │                                  │
│                        └──────┬──────┘                                  │
│                               │                                          │
│                               │ 14:30后跌幅>1%                          │
│                               ▼                                          │
│                        ┌─────────────┐                                  │
│               ┌────────│  WATCHING   │────────┐                         │
│               │        │  (观察中)    │        │                         │
│               │        └──────┬──────┘        │                         │
│               │               │               │                         │
│               │ 跌幅>2%        │ 收盘          │ 未触发                   │
│               │ (追加)        │               │                         │
│               ▼               ▼               ▼                         │
│        ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │
│        │ POSITION_1  │ │ POSITION_2  │ │   IDLE      │                  │
│        │ (持仓1档)    │ │ (持仓2档)    │ │  (空仓)     │                  │
│        └──────┬──────┘ └──────┬──────┘ └─────────────┘                  │
│               │               │                                          │
│               │ 次日开盘      │ 次日开盘                                 │
│               ▼               ▼                                          │
│        ┌─────────────────────────────────┐                              │
│        │           CLOSING               │                              │
│        │          (平仓中)                │                              │
│        └──────────────┬──────────────────┘                              │
│                       │                                                  │
│                       │ 平仓完成                                         │
│                       ▼                                                  │
│                ┌─────────────┐                                          │
│                │    IDLE     │                                          │
│                │   (空仓)     │                                          │
│                └─────────────┘                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 策略核心逻辑

```python
class SettlementArbitrageStrategy:
    """结算价差套利策略 - 完整版"""
    
    def __init__(self, config: StrategyConfig):
        self.config = config
        self.state = StrategyState.IDLE
        self.positions = []
        
    def on_bar(self, bar: MinuteBar):
        """每根K线触发"""
        current_time = bar.datetime.time()
        
        # 判断是否在观察时段 (14:30-15:00)
        if not self._is_watch_period(current_time):
            return
            
        # 获取14:30基准价
        if self.base_price is None:
            self.base_price = self._get_base_price_at_1430()
            
        # 计算跌幅
        drop_pct = (bar.close - self.base_price) / self.base_price
        
        # 检查入场条件
        if self.state == StrategyState.IDLE:
            if drop_pct <= -self.config.entry_threshold_1:  # -1%
                self._open_position(bar, level=1)
                self.state = StrategyState.POSITION_1
                
        elif self.state == StrategyState.POSITION_1:
            if drop_pct <= -self.config.entry_threshold_2:  # -2%
                self._open_position(bar, level=2)
                self.state = StrategyState.POSITION_2
                
    def on_day_open(self, bar: DayBar):
        """次日开盘触发"""
        if self.state in [StrategyState.POSITION_1, StrategyState.POSITION_2]:
            self._close_all_positions(bar.open)
            self.state = StrategyState.IDLE
            
    def _open_position(self, bar: MinuteBar, level: int):
        """开仓"""
        position = Position(
            symbol=bar.symbol,
            entry_price=bar.close,
            entry_time=bar.datetime,
            quantity=self.config.position_size[level],
            level=level
        )
        self.positions.append(position)
        self.notifier.send_buy_signal(position)
        
    def _close_all_positions(self, price: float):
        """平仓"""
        total_pnl = 0
        for pos in self.positions:
            pnl = (price - pos.entry_price) * pos.quantity * self.config.multiplier
            pnl -= self._calc_fee(pos, price)
            total_pnl += pnl
        self.notifier.send_sell_signal(self.positions, price, total_pnl)
        self.positions = []
```

### 6.3 配置文件

```yaml
# config/settlement_strategy_config.yaml

strategy:
  name: "结算价差套利策略"
  version: "1.0"
  
# 交易品种
symbols:
  - code: "IM0"        # 中证1000主力
    multiplier: 200    # 合约乘数
    enabled: true
  - code: "IC0"        # 中证500主力
    multiplier: 200
    enabled: true
  - code: "IF0"        # 沪深300主力
    multiplier: 300
    enabled: false
  - code: "IH0"        # 上证50主力
    multiplier: 300
    enabled: false

# 入场条件
entry:
  watch_start: "14:30:00"       # 观察开始时间
  watch_end: "15:00:00"         # 观察结束时间
  threshold_1: 0.01             # 首仓阈值 (1%)
  threshold_2: 0.02             # 追加阈值 (2%)
  alert_threshold: 0.008        # 预警阈值 (0.8%)

# 出场条件
exit:
  type: "next_day_open"         # 次日开盘平仓
  
# 仓位管理
position:
  size_level_1: 1               # 首仓手数
  size_level_2: 1               # 追加手数
  max_position: 2               # 单品种最大持仓
  
# 风控设置
risk:
  max_daily_loss: 10000         # 单日最大亏损(元)
  max_drawdown: 0.05            # 最大回撤比例
  force_close: true             # 触发后强制平仓

# 通知设置
notification:
  channels:
    - telegram
    - email
  events:
    - buy_signal
    - sell_signal
    - price_alert
    - daily_report
```

---

## 7. 回测系统增强

### 7.1 期货回测特性

| 特性 | 描述 | 实现状态 |
|------|------|----------|
| 保证金计算 | 按合约价值×保证金比例 | MVP已实现 |
| 手续费计算 | 区分开仓/平仓/平今 | MVP已实现 |
| 结算价模拟 | VWAP计算 | MVP已实现 |
| 涨跌停处理 | 基于前结算价±10% | MVP已实现 |
| **分钟级回测** | 支持分钟K线回测 | 🆕 完整版新增 |
| **日内信号** | 支持14:30后信号触发 | 🆕 完整版新增 |
| **跨日持仓** | 今买明卖的P&L计算 | 🆕 完整版新增 |
| **移仓换月** | 主力合约切换处理 | 🆕 完整版新增 |

### 7.2 回测报告增强

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     股指期货结算价套利策略 - 回测报告                     │
│                        2025-01-01 至 2026-02-08                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  📊 基础绩效                                                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 总收益率:  +15.6%      年化收益:  +14.2%      夏普比率:  1.85   │    │
│  │ 最大回撤:  -3.2%       胜率:      68.5%      盈亏比:    2.1    │    │
│  │ 交易次数:  89          盈利次数:  61         亏损次数:  28      │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  📈 月度收益分布                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Jan │████████████                    │ +2.3%                  │    │
│  │  Feb │███████████████                 │ +2.8%                  │    │
│  │  Mar │█████████                       │ +1.5%                  │    │
│  │  Apr │█████████████████████           │ +3.5%                  │    │
│  │  May │███                             │ +0.5%                  │    │
│  │  Jun │████████████                    │ +2.1%                  │    │
│  │  ... │                                │                        │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  📋 品种分析                                                             │
│  ┌───────┬──────────┬──────────┬──────────┬──────────────────────┐    │
│  │ 品种  │ 交易次数  │ 胜率      │ 平均盈亏  │ 总盈亏              │    │
│  ├───────┼──────────┼──────────┼──────────┼──────────────────────┤    │
│  │ IM    │ 45       │ 71.1%    │ +1,850   │ +83,250             │    │
│  │ IC    │ 44       │ 65.9%    │ +1,620   │ +71,280             │    │
│  └───────┴──────────┴──────────┴──────────┴──────────────────────┘    │
│                                                                          │
│  ⚠️ 风险分析                                                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 最大单日亏损:  -8,500元 (2025-06-15)                           │    │
│  │ 最长连亏天数:  5天                                              │    │
│  │ 最大连亏金额:  -12,300元                                        │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 通知与监控

### 8.1 通知类型

| 类型 | 触发条件 | 内容 | 优先级 |
|------|----------|------|--------|
| **买入信号** | 14:30后跌幅>阈值 | 合约/价格/跌幅/建议 | 🔴 高 |
| **卖出信号** | 次日开盘 | 合约/开盘价/盈亏 | 🔴 高 |
| **价格预警** | 跌幅接近0.8% | 当前跌幅/距离触发 | 🟡 中 |
| **日报** | 每日15:30 | 当日操作/盈亏汇总 | 🟢 低 |
| **周报** | 每周五 | 本周绩效汇总 | 🟢 低 |
| **异常告警** | 数据异常/系统错误 | 错误详情 | 🔴 高 |

### 8.2 通知模板示例

```
🚀 【买入信号】结算价套利

📊 合约: IM2503 (中证1000主力)
📉 当前价: 5,826.4
📌 14:30价: 5,892.0
📉 跌幅: -1.11%
📊 结算价(VWAP): 5,861.2
📈 收盘价vs结算价: -0.59%
⏰ 时间: 2026-02-08 14:45:00

💡 建议: 买入1手，预计次日开盘获利
💰 预期收益: ~6,900元 (基于历史结算价差)

🔔 第1档建仓，如继续下跌至-2%将追加建仓
```

### 8.3 监控面板设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      结算价套利策略 - 实时监控                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  🟢 策略状态: 运行中                    ⏰ 当前时间: 14:35:28            │
│  📅 交易日: 2026-02-08                  📊 观察阶段: 14:30-15:00        │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         品种监控                                  │  │
│  ├───────┬──────────┬──────────┬──────────┬──────────┬─────────────┤  │
│  │ 品种  │ 14:30价  │ 当前价   │ 跌幅     │ 结算价    │ 状态        │  │
│  ├───────┼──────────┼──────────┼──────────┼──────────┼─────────────┤  │
│  │ IM    │ 5,892.0  │ 5,826.4  │ -1.11% 🔴│ 5,861.2  │ ✅ 已触发    │  │
│  │ IC    │ 4,521.0  │ 4,498.6  │ -0.50%   │ 4,512.3  │ 观察中      │  │
│  │ IF    │ 3,852.0  │ 3,844.2  │ -0.20%   │ 3,849.5  │ 观察中      │  │
│  │ IH    │ 2,486.0  │ 2,478.4  │ -0.31%   │ 2,483.2  │ 观察中      │  │
│  └───────┴──────────┴──────────┴──────────┴──────────┴─────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         当前持仓                                  │  │
│  ├───────┬──────────┬──────────┬──────────┬──────────┬─────────────┤  │
│  │ 合约  │ 方向     │ 数量     │ 开仓价   │ 浮盈     │ 开仓时间    │  │
│  ├───────┼──────────┼──────────┼──────────┼──────────┼─────────────┤  │
│  │ IM2503│ 多       │ 1手      │ 5,826.4  │ +0       │ 14:33:15    │  │
│  └───────┴──────────┴──────────┴──────────┴──────────┴─────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         今日交易记录                              │  │
│  ├───────┬──────────┬──────────┬──────────┬──────────┬─────────────┤  │
│  │ 时间  │ 品种     │ 操作     │ 价格     │ 数量     │ 备注        │  │
│  ├───────┼──────────┼──────────┼──────────┼──────────┼─────────────┤  │
│  │ 14:33 │ IM2503   │ 买入     │ 5,826.4  │ 1手      │ 跌幅-1.11%  │  │
│  └───────┴──────────┴──────────┴──────────┴──────────┴─────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 前端界面设计

### 9.1 页面清单

| 页面 | 路径 | 功能 |
|------|------|------|
| **策略概览** | `/settlement-strategy` | 策略状态/实时监控 |
| **策略配置** | `/settlement-strategy/config` | 参数设置 |
| **回测** | `/settlement-strategy/backtest` | 历史回测 |
| **交易记录** | `/settlement-strategy/trades` | 交易历史 |
| **绩效报告** | `/settlement-strategy/report` | 绩效统计 |

### 9.2 核心界面原型

#### 策略配置页面

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ⚙️ 结算价套利策略配置                                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  📊 交易品种                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ ☑ IM (中证1000)    ☑ IC (中证500)                               │  │
│  │ ☐ IF (沪深300)     ☐ IH (上证50)                                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  📈 入场条件                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 首仓阈值:    [  1.0  ] %          观察开始: [ 14:30 ]            │  │
│  │ 追加阈值:    [  2.0  ] %          观察结束: [ 15:00 ]            │  │
│  │ 预警阈值:    [  0.8  ] %                                         │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  💰 仓位管理                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 首仓手数:    [  1  ]              追加手数: [  1  ]              │  │
│  │ 单品种上限:  [  2  ] 手           总仓位上限: [  4  ] 手          │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  🛡️ 风控设置                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 单日最大亏损: [ 10000 ] 元        最大回撤: [  5  ] %            │  │
│  │ ☑ 触发后强制平仓                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  🔔 通知设置                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ ☑ Telegram    ☑ Email    ☐ SMS                                  │  │
│  │ ☑ 买入信号    ☑ 卖出信号    ☑ 价格预警    ☐ 日报                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│                                           [ 重置 ]    [ 保存配置 ]      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 开发任务清单

### 10.1 任务分解

| 阶段 | 任务ID | 任务描述 | 预计工时 | 依赖 | 优先级 |
|------|--------|----------|----------|------|--------|
| **数据层** | D-01 | 分钟K线数据接口增强 | 4h | - | P0 |
| | D-02 | 实时数据订阅机制 | 6h | D-01 | P0 |
| | D-03 | 数据缓存与存储 | 4h | D-01 | P1 |
| | D-04 | 交易日历集成 | 2h | - | P1 |
| **策略层** | S-01 | 策略核心逻辑开发 | 8h | D-01 | P0 |
| | S-02 | VWAP结算价计算模块 | 4h | D-01 | P0 |
| | S-03 | 仓位管理模块 | 4h | S-01 | P1 |
| | S-04 | 风控管理模块 | 4h | S-01 | P1 |
| | S-05 | 多品种支持 | 3h | S-01 | P1 |
| **执行层** | E-01 | 信号队列与处理 | 4h | S-01 | P0 |
| | E-02 | 通知模块集成 | 4h | E-01 | P0 |
| | E-03 | 策略调度器 | 6h | S-01, D-02 | P0 |
| **回测** | B-01 | 分钟级回测引擎 | 8h | D-01 | P1 |
| | B-02 | 跨日持仓处理 | 4h | B-01 | P1 |
| | B-03 | 绩效报告增强 | 4h | B-01 | P2 |
| **前端** | F-01 | 策略监控面板 | 8h | S-01 | P1 |
| | F-02 | 策略配置页面 | 6h | - | P1 |
| | F-03 | 回测结果展示 | 6h | B-01 | P2 |
| | F-04 | 交易记录页面 | 4h | E-01 | P2 |

### 10.2 开发阶段规划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        完整版开发路线图                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Phase 1: 核心功能 (2-3周)                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ D-01 → D-02 → S-01 → S-02 → E-01 → E-02 → E-03                 │   │
│  │ [数据接口] [实时订阅] [策略核心] [VWAP] [信号队列] [通知] [调度]   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  🎯 里程碑: 策略能实时运行并发送买卖信号                                │
│                                                                          │
│  Phase 2: 完善功能 (1-2周)                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ D-03 → D-04 → S-03 → S-04 → S-05                               │   │
│  │ [数据缓存] [日历] [仓位管理] [风控] [多品种]                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  🎯 里程碑: 策略具备完整的资金管理和风控                                │
│                                                                          │
│  Phase 3: 回测与前端 (2-3周)                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ B-01 → B-02 → B-03 → F-01 → F-02 → F-03 → F-04                 │   │
│  │ [分钟回测] [跨日] [报告] [监控] [配置] [回测UI] [交易记录]        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  🎯 里程碑: 完整的可视化界面和回测系统                                  │
│                                                                          │
│  📅 预计总工期: 5-8 周                                                  │
│  👥 建议人力: 1-2 人                                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.3 工时统计

| 阶段 | 任务数 | 总工时 |
|------|--------|--------|
| 数据层 | 4 | 16h |
| 策略层 | 5 | 23h |
| 执行层 | 3 | 14h |
| 回测 | 3 | 16h |
| 前端 | 4 | 24h |
| **总计** | **19** | **~93h (约12人日)** |

---

## 11. 测试计划

### 11.1 测试类型

| 测试类型 | 覆盖范围 | 验收标准 |
|----------|----------|----------|
| **单元测试** | 各模块核心函数 | 覆盖率 > 80% |
| **集成测试** | 模块间交互 | 主流程通过 |
| **回测验证** | 策略逻辑正确性 | 与手工计算一致 |
| **实时测试** | 真实环境运行 | 信号准确、通知及时 |
| **压力测试** | 高频数据处理 | 延迟 < 1s |

### 11.2 测试用例

| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| TC-01 | 14:35跌幅达到1.05% | 触发买入信号 |
| TC-02 | 跌幅0.95%未达阈值 | 不触发信号 |
| TC-03 | 14:29下跌1.5% | 不触发(时间未到) |
| TC-04 | 首仓后跌幅达2.1% | 追加建仓 |
| TC-05 | 次日开盘 | 自动平仓 |
| TC-06 | 数据中断后恢复 | 策略正常恢复 |
| TC-07 | 非交易日 | 策略不运行 |
| TC-08 | 涨停/跌停 | 正确处理限价 |

---

## 12. 风险与依赖

### 12.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| akshare接口变更 | 数据获取失败 | 备用数据源(tushare) |
| 实时数据延迟 | 信号延迟 | 多源验证、本地缓存 |
| 服务器不稳定 | 策略中断 | 断线重连、状态持久化 |

### 12.2 外部依赖

| 依赖 | 用途 | 备选方案 |
|------|------|----------|
| akshare | 期货数据 | tushare (需token) |
| 新浪财经 | 实时行情 | 东方财富 |
| Telegram API | 通知 | Email/SMS |

### 12.3 假设与约束

| 类型 | 内容 |
|------|------|
| 假设 | 用户已有基本的期货交易知识 |
| 假设 | 用户有稳定的网络环境 |
| 约束 | 仅支持中金所股指期货 |
| 约束 | 暂不支持CTP实盘交易 |

---

## 📝 文档历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-09 | 初始版本，完整功能规划 |

---

## 🚀 下一步行动

1. **评审本文档** - 确认需求范围和优先级
2. **细化技术方案** - 针对P0任务输出详细设计
3. **开始Phase 1开发** - 从数据层和策略核心开始

**是否批准开始完整版开发？**
